<!-- Content -->
<div class="issue-container">

  <!-- Header with gradient background -->
  <div class="issue-header">
    <button title="Back to Issue" class="back-btn" (click)="goBack()">
      <i class="bi bi-arrow-left"></i>
    </button>
    <div class="header-content">
      <div class="issue-type-badge">
        <i class="bi bi-shield-lock-fill"></i>
        <span>{{ issuesResult?.type }}</span>
      </div>
      <h2 class="issue-title">{{ issuesResult?.message }}</h2>
    </div>
  </div>

  <!-- Issue Info Cards -->
  <div class="issue-info-grid">
    <!-- Card 1: Basic Info -->
    <div class="info-card">
      <h4 class="card-title"><i class="bi bi-info-circle-fill"></i> Basic Information</h4>
      <div class="info-item">
        <span class="info-label">ID</span>
        <span class="info-value">{{ issuesResult?.id }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Type</span>
        <span class="info-value">{{ issuesResult?.type }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">File</span>
        <span class="info-value text-truncate" [title]="issuesResult?.component">
          {{ issuesResult?.component }}
        </span>
      </div>
    </div>

    <!-- Card 2: Status & Severity -->
    <div class="info-card">
      <h4 class="card-title"><i class="bi bi-flag-fill"></i> Status & Priority</h4>
      <div class="info-item">
        <span class="info-label">Severity</span>
        <span [ngClass]="['badge','badge-severity','severity-'+(issuesResult?.severity || '').toLowerCase()]">
          <i class="bi bi-exclamation-triangle-fill"></i>
          {{ issuesResult?.severity }}
        </span>
        
      </div>
            <div class="info-item">
        <span class="info-label">Line</span>
        <span>
          <i class="bi bi-circle-fill"></i>
          {{ issuesResult?.line}}
        </span>
      </div>
      <div class="info-item">
        <span class="info-label">Status</span>
        <span [ngClass]="['badge','badge-status','status-'+(issuesResult?.status || '').toLowerCase()]">
          <i class="bi bi-circle-fill"></i>
          {{ issuesResult?.status }}
        </span>
      </div>
      <div class="info-item">
        <span class="info-label">Created</span>
        <span class="info-value">
          <i class="bi bi-calendar-event"></i>
          {{ issuesResult?.createdAt | date:'dd/MM/yyyy, hh:mm a' }}
        </span>
      </div>
    </div>

    <!-- Card 3: Assignment -->
    <div class="info-card">
      <h4 class="card-title"><i class="bi bi-person-fill"></i> Assignment</h4>
      <div class="info-item">
        <span class="info-label">Assigned To</span>
        <span class="info-value" *ngIf="issuesResult?.assignedTo?.username">
          <div class="assignee-tag">
            <i class="bi bi-person-circle"></i>
            {{ issuesResult?.assignedTo?.username }}
          </div>
        </span>
        <span class="info-value text-muted" *ngIf="!issuesResult?.assignedTo?.username">
          <i class="bi bi-person-dash"></i>
          No assignee
        </span>
      </div>
      <div class="info-item mt-3">
        <button type="button" class="btn btn-assign" (click)="openAssignModal()" title="Add Assignee">
          <i class="bi bi-person-plus-fill"></i>
          Assign / Update
        </button>
      </div>
    </div>
     <!-- Card 4: Status -->
       <div class="info-card">
      <h4 class="card-title"><i class="bi bi-person-fill"></i> Status</h4>
      <div class="info-item">
        <span class="info-label">Status</span>
        <span class="info-value" *ngIf="issuesResult?.status">
          <div class="">
        <span [ngClass]="['badge','badge-status','status-'+(issuesResult?.status || '').toLowerCase()]">
          <i class="bi bi-circle-fill"></i>
          {{ issuesResult?.status }}
        </span>
          </div>
        </span>
        <span class="info-value text-muted" *ngIf="!issuesResult?.status">
          <i class="bi bi-person-dash"></i>
          No Status
        </span>
      </div>
      <div class="info-item mt-3">
        <button type="button" class="btn btn-assign" (click)="openStatusModal()" title="Add Status">
          <i class="bi bi-person-plus-fill"></i>
          Status
        </button>
      </div>
    </div>
  </div>

  <!-- Description Section -->
  <div class="description-section">
    <div class="section-header">
      <h3><i class="bi bi-file-text-fill"></i> Description & Analysis</h3>
    </div>
    
    <div class="description-content">
      <div class="description-text">
        <p>{{ issuesDetails?.description }}</p>
      </div>

      <div class="code-section" *ngIf="issuesDetails?.vulnerableCode">
        <div class="code-header">
          <span><i class="bi bi-code-slash"></i> Vulnerable Code</span>
          <button class="btn-copy" title="Copy code">
            <i class="bi bi-clipboard"></i>
          </button>
        </div>
        <pre class="code-block"><code>{{ issuesDetails?.vulnerableCode }}</code></pre>
      </div>

      <div class="recommendation-box" *ngIf="issuesDetails?.recommendedFix">
        <div class="recommendation-header">
          <i class="bi bi-lightbulb-fill"></i>
          <strong>Recommended Fix</strong>
        </div>
        <p>{{ issuesDetails?.recommendedFix }}</p>
      </div>
    </div>
  </div>

  <!-- Comments Section -->
  <div class="comments-section">
    <div class="section-header">
      <h3>
        <i class="bi bi-chat-left-dots-fill"></i>
        Comments
        <span class="comment-count">{{ issuesResult?.commentData?.length || 0 }}</span>
      </h3>

    </div>

    <!-- Comment List -->
<div class="comments-list">

  <!-- Root comments -->
  <div class="reply-item"
       *ngFor="let c of rootComments; trackBy: trackByComment">
  <div class="comment-item">
    <div class="comment-avatar">
      <i class="bi bi-person-circle"></i>
    </div>

    <div class="comment-content ">
      <div class="comment-header">
        <strong class="comment-author">{{ c.user?.username }}</strong>
        <span class="comment-time">
          <i class="bi bi-clock"></i>
          {{ c.createdAt | date:'dd/MM/yyyy, HH:mm' }}
        </span>
      </div>
      <p class="comment-text">{{ c.comment }}</p>
    </div>

    <div class="comment-actions">
      <button type="button" class="btn btn-link p-0" (click)="startReply(c)">
        Reply
      </button>
    </div>
    </div>

    <!-- Replies under this comment -->
    <div class="replies" *ngIf="(replies.get(c.id) ?? []).length">
      <div class="comment-item reply-item"
           *ngFor="let r of replies.get(c.id); trackBy: trackByComment">
        <div class="comment-avatar">
          <i class="bi bi-person-circle"></i>
        </div>

        <div class="comment-content">
          <div class="comment-header">
            <strong class="comment-author">{{ r.user?.username }}</strong>
            <span class="comment-time">
              <i class="bi bi-clock"></i>
              {{ r.createdAt | date:'dd/MM/yyyy, HH:mm' }}
            </span>
          </div>
          <p class="comment-text">{{ r.comment }}</p>
        </div>

        <div class="comment-actions">
        </div>

      </div>
    </div>

  </div>

  <!-- Empty State -->
  <div *ngIf="!rootComments.length && !loadingComments" class="empty-comments">
    <i class="bi bi-chat-square-text"></i>
    <p>No comments yet. Be the first to share your thoughts!</p>
  </div>
</div>


    <!-- Add Comment -->
<div class="add-comment-box">

  <!-- Replying banner -->
  <div class="replying-banner" *ngIf="replyTo">
    <span>Replying to <b>{{ replyTo.username }}</b></span>
    <button type="button" class="btn btn-sm btn-light" (click)="cancelReply()">
      Cancel
    </button>
  </div>

  <div class="comment-input-wrapper">
    <i class="bi bi-chat-dots input-icon"></i>

    <input 
      type="text" 
      [placeholder]=" 'Write a comment...'" 
      [(ngModel)]="newComment.comment"
      name="commentText"
      class="comment-input" 
      title="Write your comment"
      (keyup.enter)="newComment?.comment?.trim() && postComment()"
    />

    <button 
      class="btn-send" 
      type="button" 
      title="Post comment" 
      (click)="postComment()"
      [disabled]="!newComment.comment?.trim() || sendingComment"
    >
      <i class="bi bi-send-fill" *ngIf="!sendingComment"></i>
      <span class="spinner-border spinner-border-sm" *ngIf="sendingComment"></span>
    </button>
  </div>
</div>

  </div>

  <!-- Modal -->
  <app-issuemodal 
    #assignModal 
    [issue]="issueForModal" 
    (assignSubmit)="handleAssignSubmit($event)" 
    (statusSubmit)="handleStatusSubmit($event)"
    (closed)="{}">
  </app-issuemodal>

</div>
