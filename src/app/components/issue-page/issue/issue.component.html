<!-- Issues Management Page -->
<div class="issues-container my-0">
  <!-- Header -->
  <div class="issues-header d-flex justify-content-between align-items-center">
    <h2><i class="bi bi-list-task me-2"></i> Issues Management</h2>

    <!-- ปุ่ม My Assignment ฝั่งขวา -->
    <a [routerLink]="['/assignment']" class="custom-btn" title="My Assignment">
      <i class="bi bi-person-badge me-1"></i>Assignment
    </a>
  </div>

  <!-- Filters & Search -->
  <div class="d-flex flex-wrap gap-2 mb-4 align-items-center filters">
    <select class="form-select w-auto" [(ngModel)]="filterType" (ngModelChange)="applyFilter()">
      <option>All Types</option>
      <option value="bug">Bug</option>
      <option value="security">Security</option>
      <option value="Code_smell">Code Smell</option>
    </select>

    <select class="form-select w-auto" [(ngModel)]="filterSeverity" (ngModelChange)="applyFilter()">
      <option>All Severity</option>
      <option value="critical">CRITICAL</option>
      <option value="MAJOR">MAJOR</option>
      <option value="MINOR">MINOR</option>
    </select>

    <select class="form-select w-auto" [(ngModel)]="filterStatus" (ngModelChange)="applyFilter()">
      <option>All Status</option>
      <option value="open">Open</option>
      <option value="pending">Pending</option>
      <option value="in-progress">In Progress</option>
      <option value="resolved">Resolved</option>
      <option value="closed">Closed</option>
    </select>

    <select class="form-select w-auto" [(ngModel)]="filterProject" (change)="applyFilter()">
      <option value="All Projects">All Projects</option>
      <option *ngFor="let project of repositories" [value]="project.name">
        {{ project.name }}
      </option>
    </select>
    <input class="form-control w-auto" type="text" placeholder="Search issues..." [(ngModel)]="searchText"
      (ngModelChange)="onSearchChange($event)">
    <button class="btn btn-outline-primary" (click)="clearFilters()">Clear</button>
  </div>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover table-bordered align-middle issues-table">
      <thead>
        <tr>
          <th class="text-center">
            <input type="checkbox" [checked]="allSelected()" (change)="toggleSelectAll($event)">
          </th>
          <th>Type</th>
          <th>Severity</th>
          <th>Issue</th>
          <th>Project</th>
          <th>Assigned</th>
          <th>Status</th>
          <th class="text-center view-column sticky-col">View</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="paginatedIssues?.length === 0">
          <td colspan="8" class="text-center text-muted py-4">
            <i class="bi bi-inbox"></i> No Data
          </td>
        </tr>
        <tr *ngFor="let issue of paginatedIssues">
          <td (click)="$event.stopPropagation()">
            <input type="checkbox" [checked]="isSelected(issue)" (change)="toggleIssueSelection(issue, $event)" />
          </td>
          <td><i class="bi me-1" [ngClass]="typeIcon(issue.type)"></i>{{ issue.type | titlecase }}</td>
          <td>
            <span class="severity-badge" [ngClass]="severityClass(issue.severity)">
              {{ issue.severity | uppercase }}
            </span>
          </td>

          <td>
            <strong class="issue-message">{{ issue.message }}</strong><br>
          </td>
          <td>{{issue.projectData?.name}}</td>
          <td>{{issue.assignedTo?.username ?? 'Unassigned'}}</td>
          <td>
            <span class="status-badge" [ngClass]="statusClass(issue.status)">
              {{ formatStatus(issue.status) }}
            </span>
          </td>

          <td class="text-center sticky-col">
            <button *ngIf="issue?.id" (click)="viewResult(issue)" class="btn btn-info btn-sm">
              <i class="bi bi-eye"></i>
            </button>
          </td>
        </tr>
        <!-- Empty State -->
        <tr *ngIf="paginatedIssues?.length === 0">
          <td colspan="8" class="text-center text-muted py-4">
            <i class="bi bi-inbox"></i> No Data
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ✅ Assign Modal (inline in same page) -->
<div class="modal-backdrop-custom" *ngIf="showAssignModal" (click)="closeAssignModal()"></div>

<div class="modal-custom" *ngIf="showAssignModal" (click)="$event.stopPropagation()">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <div class="modal-header">
      <h3 class="modal-title">Assign Issues</h3>
      <button type="button" class="btn-close" (click)="closeAssignModal()" aria-label="Close">✕</button>
    </div>

    <form #assignForm="ngForm" (ngSubmit)="saveAssign(assignForm)">
      <div class="modal-body">

        <!-- Selected count -->
        <div class="mb-3">
          <label class="form-label">Selected Issues:</label>
          <input class="form-control" [value]="selectedIssues.length + ' issues selected'" readonly />
        </div>

        <!-- Assign to user -->
        <div class="mb-3">
          <label class="form-label">Assign to:</label>
          <select class="form-control" [(ngModel)]="issueDraft.assignedTo" name="assignedTo" required>
            <option value="" disabled>-- Select user --</option>
            <option *ngFor="let u of UserData" [value]="u.id">
              {{ u.username }}
            </option>
          </select>

          <div class="text-danger mt-1" *ngIf="assignForm.submitted && !issueDraft.assignedTo">
            Please select a user
          </div>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeAssignModal()">Cancel</button>

        <button type="submit" class="btn btn-primary" [disabled]="savingAssign">
          <span *ngIf="!savingAssign">Save</span>
          <span *ngIf="savingAssign" class="spinner-border spinner-border-sm"></span>
        </button>
      </div>
    </form>

  </div>
</div>

<!-- Footer -->
<div class="footer-bar px-3 px-md-4">
  <div class="footer-left">
  </div>
  <div class="pagination d-flex align-items-center gap-3">
    <button class="page-btn" [class.disabled]="currentPage === 1" [disabled]="currentPage === 1" (click)="prevPage()">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="page-label mb-0">Page {{ currentPage }} / {{totalPages}}</span>
    <button class="page-btn" [class.disabled]="currentPage === totalPages" [disabled]="currentPage === totalPages"
      (click)="nextPage()">
      <i class="bi bi-chevron-right"></i>
    </button>
  </div>

  <div class="bottom-action-buttons">
    <button class="action-btn assign" (click)="openAssignModal()" title="Assign Developer">
      <i class="bi bi-person-plus"></i>
    </button>
    <button class="action-btn export" (click)="exportData()" title="Export">
      <i class="bi bi-download"></i>
    </button>
  </div>

</div>