<div class="scan-result-dashboard fade-in">

  <div class="dashboard-header">
    <div class="header-title">
      <button title="Back" class="back-btn" (click)="goBack()">
        <i class="bi bi-chevron-left"></i>
      </button>
      <div class="header-content">
        <h1>Scan Results: {{ scanResult?.project?.name }}</h1>
        <p>Detailed analysis report and quality metrics</p>
      </div>
    </div>

    <div class="header-actions">
      <button class="btn-action btn-download" (click)="downloadReport()">
        <i class="bi bi-download"></i> Download
      </button>
      <button class="btn-action btn-email" (click)="emailReport()">
        <i class="bi bi-envelope"></i> Email
      </button>
      <button class="btn-action btn-issues" [routerLink]="['/issue']"
        [queryParams]="{ project: scanResult?.project?.name, scanId: scanResult?.id }">
        <i class="bi bi-list-check"></i> View Issues
      </button>
    </div>
  </div>

  <ng-container *ngIf="scanResult; else loadingOrError">
    <!-- Top Stats -->
    <div class="stats-grid">
      <!-- Quality Gate Card -->
      <div class="stat-panel qa-panel">
        <label class="section-label mb-3">Quality Gate Status</label>
        <div class="qa-gate-content">
          <div class="qa-status">
            <i class="bi qa-icon"
              [ngClass]="scanResult.qualityGate === 'OK' ? 'bi-check-circle-fill pass' : 'bi-x-circle-fill fail'"></i>
            <div class="qa-text">
              <h3 [ngClass]="scanResult.qualityGate === 'OK' ? 'pass' : 'fail'">
                {{ scanResult.qualityGate === 'OK' ? 'Passed' : 'Failed' }}
              </h3>
              <span>{{ scanResult.qualityGate === 'OK' ? 'Code is safe and clean' : 'Issues found, please review'
                }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Timing Card -->
      <div class="stat-panel timing-panel">
        <label class="section-label mb-4">Scan Duration</label>
        <div class="scan-timing-list">
          <div class="timing-item">
            <label>Started</label>
            <div>
              <i class="bi bi-calendar-event me-2 text-primary"></i>
              {{ scanResult.startedAt | date:'dd/MM/yyyy HH:mm' }}
            </div>
          </div>

          <div class="vr bg-secondary opacity-25"></div>

          <div class="timing-item">
            <label>Completed</label>
            <div>
              <i class="bi bi-check2-circle me-2 text-success"></i>
              {{ scanResult.completedAt | date:'dd/MM/yyyy HH:mm' }}
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Metrics Grid -->
    <div class="metrics-section-title">
      <i class="bi bi-bar-chart-line-fill text-primary"></i> Metrics Overview
    </div>

    <div class="metrics-grid">
      <!-- Bugs -->
      <div class="metric-card metric-bugs">
        <div class="metric-icon-box">
          <i class="bi bi-bug"></i>
        </div>
        <div class="metric-info">
          <h4>{{ scanResult.metrics?.bugs ?? 0 }}</h4>
          <span>Bugs</span>
        </div>
      </div>

      <!-- Vulnerabilities -->
      <div class="metric-card metric-vuln">
        <div class="metric-icon-box">
          <i class="bi bi-shield-exclamation"></i>
        </div>
        <div class="metric-info">
          <h4>{{ scanResult.metrics?.vulnerabilities ?? 0 }}</h4>
          <span>Vulnerabilities</span>
        </div>
      </div>

      <!-- Code Smells -->
      <div class="metric-card metric-smells">
        <div class="metric-icon-box">
          <i class="bi bi-code-slash"></i>
        </div>
        <div class="metric-info">
          <h4>{{ scanResult.metrics?.codeSmells ?? 0 }}</h4>
          <span>Code Smells</span>
        </div>
      </div>

      <!-- Coverage -->
      <div class="metric-card metric-coverage">
        <div class="metric-icon-box">
          <i class="bi bi-graph-up"></i>
        </div>
        <div class="metric-info">
          <h4>{{ scanResult.metrics?.coverage ?? 0 }}%</h4>
          <span>Coverage</span>
        </div>
      </div>
    </div>

    <!-- Overall Gates Table -->
    <div class="metrics-section-title mt-5">
      <i class="bi bi-shield-check text-primary"></i> Overall Gates
    </div>

    <div class="gates-panel">
      <table class="table">
        <thead>
          <tr>
            <th>Metric Gate</th>
            <th>Grade</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Reliability Rating</td>
            <td><span class="gate-grade">{{ scanResult.metrics?.reliabilityRating ?? '-' }}</span></td>
            <td>
              <span class="text-success" *ngIf="scanResult.metrics?.reliabilityRating === 'A'"><i
                  class="bi bi-check-circle-fill"></i> Pass</span>
              <span class="text-warning" *ngIf="scanResult.metrics?.reliabilityRating === 'B'"><i
                  class="bi bi-exclamation-circle-fill"></i> Warning</span>
              <span class="text-danger" *ngIf="['C','D','E'].includes(scanResult.metrics?.reliabilityRating || '')"><i
                  class="bi bi-x-circle-fill"></i> Fail</span>
            </td>
          </tr>
          <tr>
            <td>Security Rating</td>
            <td><span class="gate-grade">{{ scanResult.metrics?.securityRating ?? '-' }}</span></td>
            <td>
              <span class="text-success" *ngIf="scanResult.metrics?.securityRating === 'A'"><i
                  class="bi bi-check-circle-fill"></i> Pass</span>
              <span class="text-warning" *ngIf="scanResult.metrics?.securityRating === 'B'"><i
                  class="bi bi-exclamation-circle-fill"></i> Warning</span>
              <span class="text-danger" *ngIf="['C','D','E'].includes(scanResult.metrics?.securityRating || '')"><i
                  class="bi bi-x-circle-fill"></i> Fail</span>
            </td>
          </tr>
          <tr>
            <td>Maintainability Rating</td>
            <td><span class="gate-grade">{{ scanResult.metrics?.maintainabilityRating ?? '-' }}</span></td>
            <td>
              <span class="text-success" *ngIf="scanResult.metrics?.maintainabilityRating === 'A'"><i
                  class="bi bi-check-circle-fill"></i> Pass</span>
              <span class="text-warning" *ngIf="scanResult.metrics?.maintainabilityRating === 'B'"><i
                  class="bi bi-exclamation-circle-fill"></i> Warning</span>
              <span class="text-danger"
                *ngIf="['C','D','E'].includes(scanResult.metrics?.maintainabilityRating || '')"><i
                  class="bi bi-x-circle-fill"></i> Fail</span>
            </td>
          </tr>
          <tr>
            <td>Security Review Rating</td>
            <td><span class="gate-grade">{{ getAverageRating() }}</span></td>
            <td>
              <span class="text-success" *ngIf="getAverageRating() === 'A'"><i class="bi bi-check-circle-fill"></i>
                Pass</span>
              <span class="text-warning" *ngIf="getAverageRating() === 'B'"><i
                  class="bi bi-exclamation-circle-fill"></i> Warning</span>
              <span class="text-danger" *ngIf="['C','D','E'].includes(getAverageRating())"><i
                  class="bi bi-x-circle-fill"></i> Fail</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </ng-container>

  <ng-template #loadingOrError>
    <div class="empty-state" *ngIf="!scanResult">
      <div class="empty-icon"><i class="bi bi-hourglass-split"></i></div>
      <h3>Loading Results...</h3>
      <p>Please wait while we fetch the scan details.</p>
    </div>
  </ng-template>

</div>