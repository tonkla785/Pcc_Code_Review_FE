<div class="container my-4">
  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-3">
    <div>
      <h2><i class="bi bi-file-earmark-text"></i> Scan Report: {{ log.applicationName }}</h2>
      <p class="log-date mb-0">
        <strong>Date:</strong> {{ log.timestamp | date:'dd/MM/yyyy, hh:mm a' }}</p>
    </div>

    <!-- Control Buttons -->
    <div class="mt-2 mt-md-0 d-flex gap-2 flex-wrap">
      <button class="btn btn-secondary" (click)="goBack()"><i class="bi bi-arrow-left"></i> Back</button>
      <button class="btn btn-success" (click)="downloadLog()"><i class="bi bi-download"></i> Download</button>
      <button class="btn btn-primary" (click)="sendEmail()"><i class="bi bi-envelope"></i> Email</button>
      <button class="btn btn-warning" (click)="printLog()"><i class="bi bi-printer"></i> Print</button>
    </div>
  </div>

  <!-- Main Log Content -->
  <div class="log-card p-4 rounded shadow-sm bg-white">
    <!-- Execution Summary -->
    <section class="mb-4">
      <h4><i class="bi bi-clipboard-check"></i> Execution Summary</h4>
      <ul class="list-group list-group-flush">
        <li class="list-group-item d-flex justify-content-between">
          <span>Status</span>
          <span [ngClass]="{'text-success': log.content.status==='success', 'text-danger': log.content.status==='failed'}">
            {{ scanResult?.status| titlecase }}
          </span>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span>Duration</span>
          <span>{{  getDurationSeconds(scanResult?.startedAt, scanResult?.completedAt) }}</span>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span>Scanner Type</span>
          <span>{{ log.content.scannerType }}</span>
        </li>
      </ul>
    </section>

    <!-- SonarQube Results -->
    <section class="mb-4">
      <h4><i class="bi bi-graph-up"></i> SonarQube Results</h4>
<ul class="list-group list-group-flush"
    *ngIf="scanResult?.metrics; else noSonar">

  <!-- Quality -->
  <li class="list-group-item d-flex justify-content-between">
    <span>Quality Gate</span>
    <span>{{ scanResult?.qualityGate }}</span>
  </li>

  <!-- Bugs & Issues -->
  <li class="list-group-item d-flex justify-content-between">
    <span>Bugs</span>
    <span>{{ scanResult?.metrics?.bugs }}</span>
  </li>

  <li class="list-group-item d-flex justify-content-between">
    <span>Vulnerabilities</span>
    <span>{{ scanResult?.metrics?.vulnerabilities }}</span>
  </li>

  <li class="list-group-item d-flex justify-content-between">
    <span>Security Hotspots</span>
    <span>{{ scanResult?.metrics?.securityHotspots }}</span>
  </li>

  <li class="list-group-item d-flex justify-content-between">
    <span>Code Smells</span>
    <span>{{ scanResult?.metrics?.codeSmells }}</span>
  </li>

  <!-- Coverage & Duplication -->
  <li class="list-group-item d-flex justify-content-between">
    <span>Coverage</span>
    <span>{{ scanResult?.metrics?.coverage }}%</span>
  </li>

  <li class="list-group-item d-flex justify-content-between">
    <span>Duplicated Lines</span>
    <span>{{ scanResult?.metrics?.duplicatedLinesDensity }}%</span>
  </li>

  <!-- Technical Debt -->
  <li class="list-group-item d-flex justify-content-between">
    <span>Technical Debt (min)</span>
    <span>{{ scanResult?.metrics?.technicalDebtMinutes }}</span>
  </li>

  <li class="list-group-item d-flex justify-content-between">
    <span>Debt Ratio</span>
    <span>{{ scanResult?.metrics?.debtRatio }}</span>
  </li>

  <!-- Ratings -->
  <li class="list-group-item d-flex justify-content-between">
    <span>Maintainability</span>
    <span>{{ scanResult?.metrics?.maintainabilityRating }}</span>
  </li>

  <li class="list-group-item d-flex justify-content-between">
    <span>Reliability</span>
    <span>{{ scanResult?.metrics?.reliabilityRating }}</span>
  </li>

  <li class="list-group-item d-flex justify-content-between">
    <span>Security</span>
    <span>{{ scanResult?.metrics?.securityRating }}</span>
  </li>

</ul>

<ng-template #noSonar>
  <div class="text-muted p-3 text-center">
    No SonarQube result available
  </div>
</ng-template>

      <ng-template #noSonar>
        <p class="text-muted">No SonarQube results available.</p>
      </ng-template>
    </section>

    <!-- Details -->
    <section class="mb-4">
      <h4><i class="bi bi-list-ul"></i> Details</h4>
      <ul class="list-group list-group-flush">
        <li class="list-group-item" *ngFor="let d of scanResult?.metrics?.analysisLogs">{{ d.message }} - {{ d.timestamp | date:'dd/MM/yyyy HH:mm:ss':'Asia/Bangkok' }}</li>
      </ul>
    </section>

<!-- Warnings -->
<section class="mb-4" *ngIf="majorIssues?.length">
  <h4 class="mb-3">
    <i class="bi bi-exclamation-triangle text-warning"></i>
    Warnings
    <span class="badge bg-warning text-dark ms-2">
      {{ majorIssues.length }}
    </span>
  </h4>
<div class="table-responsive">
  <table class="table table-sm table-bordered align-middle major-table">
    <thead class="table-warning">
      <tr>
        <th class="col-no">#</th>
        <th class="col-msg">Message</th>
        <th class="col-comp">Component</th>
        <th class="col-line">Line</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let w of pagedMajorIssues; let i = index">
        <td class="text-center col-no">
          {{ (currentPageMajor - 1) * pageSize + i + 1 }}
        </td>

        <td class="col-msg">
          {{ w.message }}
        </td>

        <td class="col-comp text-truncate" [title]="w.component">
          {{ w.component?.split('/').pop() }}
        </td>

        <td class="text-center col-line">
          {{ w.line }}
        </td>
      </tr>
    </tbody>
  </table>
</div>


  <!-- Pagination -->
  <div class="d-flex justify-content-center align-items-center mt-2">
    <button
      class="btn btn-sm btn-outline-secondary me-2"
      (click)="prevPageMajor()"
      [disabled]="currentPageMajor === 1"
    >
        ก่อนหน้า
    </button>

    <span class="text-muted">
     {{ currentPageMajor }} / {{ totalPagesMajor }}
    </span>

    <button
      class="btn btn-sm btn-outline-secondary ms-2"
      (click)="nextPageMajor()"
      [disabled]="currentPageMajor === totalPagesMajor"
    >
       ถัดไป
    </button>
  </div>
</section>



    <!-- Errors -->
<section class="mb-4" *ngIf="criticalIssues?.length">
  <h4 class="mb-3">
    <i class="bi bi-exclamation-triangle text-danger"></i>
    Errors
    <span class="badge bg-danger text-white  ms-2">
      {{ criticalIssues.length }}
    </span>
  </h4>
<div class="table-responsive">
  <table class="table table-sm table-bordered align-middle major-table">
    <thead class="table-danger">
      <tr>
        <th class="col-no">#</th>
        <th class="col-msg">Message</th>
        <th class="col-comp">Component</th>
        <th class="col-line">Line</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let w of pagedCritical; let i = index">
        <td class="text-center col-no">
          {{ (currentPageCritical - 1) * pageSize + i + 1 }}
        </td>

        <td class="col-msg">
          {{ w.message }}
        </td>

        <td class="col-comp text-truncate" [title]="w.component">
          {{ w.component?.split('/').pop() }}
        </td>

        <td class="text-center col-line">
          {{ w.line }}
        </td>
      </tr>
    </tbody>
  </table>
</div>


  <!-- Pagination -->
  <div class="d-flex justify-content-center align-items-center mt-2">
    <button
      class="btn btn-sm btn-outline-secondary me-2"
      (click)="prevPageCritical()"
      [disabled]="currentPageCritical === 1"
    >
        ก่อนหน้า
    </button>

    <span class="text-muted">
     {{ currentPageCritical }} / {{ totalPagesCritical }}
    </span>

    <button
      class="btn btn-sm btn-outline-secondary ms-2"
      (click)="nextPageCritical()"
      [disabled]="currentPageCritical === totalPagesCritical"
    >
       ถัดไป
    </button>
  </div>
</section>
  </div>
</div>
