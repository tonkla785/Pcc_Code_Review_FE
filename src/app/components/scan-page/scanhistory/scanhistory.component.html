<div class="scan-history-container p-4">
  <h2><i class="bi bi-journal-text"></i> Scan History</h2>

  <!-- Filter / Search -->
  <div class="filter-row my-3 d-flex flex-wrap align-items-center gap-3">

    <!-- 2. Date Range -->
    <div class="d-flex align-items-center gap-2">
      <label class="fw-bold">Range:</label>
      <input #startInput type="date" [(ngModel)]="startDate" class="form-control form-control-sm"
       (ngModelChange)="applyFilterStatus()" placeholder="Start Date" (keydown)="$event.preventDefault()"
        (click)="startInput.showPicker()" />
      <span>-</span>
      <input #endInput type="date" [(ngModel)]="endDate" class="form-control form-control-sm" [min]="minEndDate"
        placeholder="End Date" (ngModelChange)="applyFilterStatus()" (keydown)="$event.preventDefault()" (click)="endInput.showPicker()" />
    </div>

    <div class="vr"></div>

    <!-- 3. Status -->
    <div class="d-flex align-items-center gap-2">
      <label class="fw-bold">Status:</label>
      <select class="form-control form-control-sm" (ngModelChange)="applyFilterStatus()" [(ngModel)]="filterType" (ngModelChange)="applyFilterStatus()"style="width: 120px;">
        <option value="ALL">ALL</option>
        <option value="SUCCESS">Success</option>
        <option value="FAILED">Failed</option>
      </select>
    </div>
<div class="d-flex align-items-center gap-2">
  <label class="fw-bold">Project:</label>
  <select
    class="form-control form-control-sm"
    style="width: 160px"
    [(ngModel)]="filterProject"
    (ngModelChange)="applyFilterStatus()"
  >
    <option value="All Projects">All Projects</option>
    <option *ngFor="let project of repositories" [value]="project.name">
      {{ project.name }}
    </option>
  </select>
</div>


    <!-- Buttons -->
    <button class="btn btn-primary btn-sm ms-auto" (click)="applyFilterStatus()">
      <i class="bi bi-search"></i> Search
    </button>

    <button class="btn btn-secondary btn-sm" (click)="resetFilters()">
      <i class="bi bi-eraser"></i> Clear
    </button>
  </div>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle scan-history-table">
      <thead class="table-light">
        <tr>
          <th style="width: 40px;">
            <input type="checkbox" [checked]="allSelected()" (change)="toggleSelectAll($event)" />
          </th>
          <th>Date/Time</th>
          <th>Project</th>
          <!-- <th>Owner Scan</th> -->
          <th>Grade</th>
          <th>Issues</th>
          <!-- <th class="log-col sticky-col">Log</th> -->
          <th class="result-col sticky-col">Result</th>
          <th></th>
        </tr>
      </thead>

      <tbody>
        <tr *ngIf="pagedScans?.length === 0">
          <td colspan="7" class="text-center text-muted py-4">
            <i class="bi bi-inbox"></i> No Data
          </td>
        </tr>
        <tr *ngFor="let scan of pagedScans" style="cursor: pointer;" (click)="toggleScanSelection(scan)">
          <td (click)="$event.stopPropagation()">
            <!-- Checkbox needs to stop propagation to prevent double toggle from TR click -->
            <input type="checkbox" [checked]="isSelected(scan)" (change)="toggleScanSelection(scan, $event)" />
          </td>

          <td>
            {{ scan.startedAt | date:'dd/MM/yyyy' }} <br /> {{ scan.startedAt | date:'HH:mm' }}
          </td>

          <td>
            {{scan.project.name}} <br />
            <span [ngClass]="statusClass(scan.status)">
              <i [ngClass]="statusIcon(scan.status)"></i> {{ scan.status === 'PENDING' ? 'SCANNING' : scan.status }}
            </span>
          </td>
          <!-- <td>{{scan.ownerScan}}</td> -->
          <td>{{ scan.qualityGate === 'OK' ? 'Pass' : 'Fail' }}</td>

          <td>
            <span *ngIf="scan.metrics?.bugs !== undefined"><i class="bi bi-bug"></i> {{scan.metrics?.bugs}}</span>
            <span *ngIf="scan.metrics?.vulnerabilities !== undefined"><i class="bi bi-shield"></i>
              {{scan.metrics?.vulnerabilities}}</span>
            <span *ngIf="scan.metrics?.codeSmells !== undefined"><i class="bi bi-code"></i>
              {{scan.metrics?.codeSmells}}</span>
            <span *ngIf="scan.metrics?.coverage !== undefined"><i class="bi bi-bar-chart"></i>
              {{scan.metrics?.coverage}}</span>
            <span *ngIf="scan.metrics?.duplicatedLinesDensity !== undefined"><i class="bi bi-duplicate"></i>
              {{scan.metrics?.duplicatedLinesDensity}}</span>
          </td>

          <td class="log-col sticky-col" (click)="$event.stopPropagation()">
            <button title="View log" class="btn btn-log btn-sm" (click)="viewLog(scan); $event.stopPropagation()">
              <i class="bi bi-file-text"></i>
            </button>
          </td>

          <td class="result-col sticky-col" (click)="$event.stopPropagation()">
            <button title="View Result Scan" class="btn btn-primary btn-sm"
              (click)="viewResult(scan); $event.stopPropagation()">
              <i class="bi bi-eye"></i>
            </button>
          </td>

        </tr>
      </tbody>
    </table>
  </div>
  <div class="pagination">
    <!-- Prev -->
    <button class="page-btn prev" [class.disabled]="currentPage === 1" (click)="goPage(currentPage - 1)">
      <i class="bi bi-chevron-left"></i>
    </button>

    <!-- Page Label -->
    <span class="page-label">Page {{currentPage}} of {{totalPages}}</span>

    <!-- Next -->
    <button class="page-btn next" [class.disabled]="currentPage === totalPages" (click)="goPage(currentPage + 1)">
      <i class="bi bi-chevron-right"></i>
    </button>
  </div>



  <!-- Actions -->
  <div class="actions mt-3 d-flex gap-2 flex-wrap">
    <button class="btn btn-success btn-sm" (click)="exportHistory()">
      <i class="bi bi-download"></i> Export History
    </button>
    <button class="btn btn-info btn-sm" (click)="compareScans()">
      <i class="bi bi-bar-chart"></i> Compare Scans
    </button>
    <button class="btn btn-danger btn-sm" (click)="clearOldLogs()">
      <i class="bi bi-trash"></i> Clear Old Logs
    </button>
  </div>
</div>

<!-- Compare Modal -->
<div *ngIf="showCompareModal" class="modal-backdrop-custom">
  <div class="modal-content-custom">
    <div class="modal-header-custom">
      <h5>Compare Scans</h5>
      <button class="btn btn-primary btn-sm" (click)="closeCompareModal()">X</button>
    </div>
    <div class="modal-body-custom">
      
      <!-- Metrics Selection - แนวนอน -->
      <div class="mb-4">
        <label class="fw-bold d-block mb-3">เลือกข้อมูลที่ต้องการเปรียบเทียบ</label>
        
        <div class="d-flex flex-wrap gap-3">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="checkGrade" [(ngModel)]="showGrade">
            <label class="form-check-label" for="checkGrade">
              <i class="bi bi-award-fill text-primary me-1"></i>
              Grade
            </label>
          </div>

          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="checkBugs" [(ngModel)]="showBugs">
            <label class="form-check-label" for="checkBugs">
              <i class="bi bi-bug-fill text-danger me-1"></i>
              Bugs
            </label>
          </div>

          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="checkSmells" [(ngModel)]="showCodeSmells">
            <label class="form-check-label" for="checkSmells">
              <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
              Code Smells
            </label>
          </div>

          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="checkCoverage" [(ngModel)]="showCoverage">
            <label class="form-check-label" for="checkCoverage">
              <i class="bi bi-shield-check text-success me-1"></i>
              Coverage
            </label>
          </div>

          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="checkDuplications" [(ngModel)]="showDuplications">
            <label class="form-check-label" for="checkDuplications">
              <i class="bi bi-files text-info me-1"></i>
              Duplications
            </label>
          </div>
        </div>
      </div>

      <!-- Comparison Table -->
      <table class="table table-hover align-middle compare-table">
        <thead>
          <tr>
            <th class="ps-3">Metric</th>
            <th *ngFor="let scan of selectedScans" class="text-center">
              {{ scan.project?.name }}
              <div class="text-muted small">
                {{ scan.startedAt | date:'yyyy-MM-dd' }}
              </div>
            </th>
            <th class="text-center pe-3">Change</th>
          </tr>
        </thead>
        <tbody>
          <!-- Grade -->
          <tr *ngIf="showGrade">
            <td class="fw-semibold ps-3">
              <i class="bi bi-award-fill text-primary me-2"></i>
              Grade
            </td>
            <td *ngFor="let scan of selectedScans" class="text-center">
              <span class="badge bg-primary-subtle text-primary px-3 py-2">
                {{ scan.qualityGate }}
              </span>
            </td>
            <td class="text-center pe-3">
              <ng-container *ngIf="diffMetric('grade') as diff; else showZero">
                <span
                  class="badge px-3 py-2"
                  [ngClass]="{
                    'bg-success-subtle text-success': diff > 0,
                    'bg-danger-subtle text-danger': diff < 0
                  }"
                >
                  {{ diff > 0 ? '▲ +' : '▼ ' }}{{ diff }}
                </span>
              </ng-container>
              <ng-template #showZero>
                <ng-container *ngIf="diffMetric('grade') === 0">
                  <span class="badge px-3 py-2 bg-secondary-subtle text-secondary">
                    – 0
                  </span>
                </ng-container>
              </ng-template>
            </td>
          </tr>

          <!-- Bugs -->
          <tr *ngIf="showBugs">
            <td class="fw-semibold ps-3">
              <i class="bi bi-bug-fill text-danger me-2"></i>
              Bugs
            </td>
            <td *ngFor="let scan of selectedScans" class="text-center">
              <span class="badge bg-danger-subtle text-danger px-3 py-2">
                {{ scan.metrics?.bugs ?? 0 }}
              </span>
            </td>
            <td class="text-center pe-3">
              <ng-container *ngIf="diffMetric('bugs') as diff; else showZeroBugs">
                <span
                  class="badge px-3 py-2"
                  [ngClass]="{
                    'bg-success-subtle text-success': diff < 0,
                    'bg-danger-subtle text-danger': diff > 0
                  }"
                >
                  {{ diff > 0 ? '▲ +' : '▼ ' }}{{ diff }}
                </span>
              </ng-container>
              <ng-template #showZeroBugs>
                <ng-container *ngIf="diffMetric('bugs') === 0">
                  <span class="badge px-3 py-2 bg-secondary-subtle text-secondary">
                    – 0
                  </span>
                </ng-container>
              </ng-template>
            </td>
          </tr>

          <!-- Code Smells -->
          <tr *ngIf="showCodeSmells">
            <td class="fw-semibold ps-3">
              <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
              Code Smells
            </td>
            <td *ngFor="let scan of selectedScans" class="text-center">
              <span class="badge bg-warning-subtle text-warning px-3 py-2">
                {{ scan.metrics?.codeSmells ?? 0 }}
              </span>
            </td>
            <td class="text-center pe-3">
              <ng-container *ngIf="diffMetric('codeSmells') as diff; else showZeroSmells">
                <span
                  class="badge px-3 py-2"
                  [ngClass]="{
                    'bg-success-subtle text-success': diff < 0,
                    'bg-danger-subtle text-danger': diff > 0
                  }"
                >
                  {{ diff > 0 ? '▲ +' : '▼ ' }}{{ diff }}
                </span>
              </ng-container>
              <ng-template #showZeroSmells>
                <ng-container *ngIf="diffMetric('codeSmells') === 0">
                  <span class="badge px-3 py-2 bg-secondary-subtle text-secondary">
                    – 0
                  </span>
                </ng-container>
              </ng-template>
            </td>
          </tr>

          <!-- Coverage -->
          <tr *ngIf="showCoverage">
            <td class="fw-semibold ps-3">
              <i class="bi bi-shield-check text-success me-2"></i>
              Coverage
            </td>
            <td *ngFor="let scan of selectedScans" class="text-center">
              <span class="badge bg-success-subtle text-success px-3 py-2">
                {{ scan.metrics?.coverage ?? 0 }}%
              </span>
            </td>
            <td class="text-center pe-3">
              <ng-container *ngIf="diffMetric('coverage') as diff; else showZeroCoverage">
                <span
                  class="badge px-3 py-2"
                  [ngClass]="{
                    'bg-success-subtle text-success': diff > 0,
                    'bg-danger-subtle text-danger': diff < 0
                  }"
                >
                  {{ diff > 0 ? '▲ +' : '▼ ' }}{{ diff }}%
                </span>
              </ng-container>
              <ng-template #showZeroCoverage>
                <ng-container *ngIf="diffMetric('coverage') === 0">
                  <span class="badge px-3 py-2 bg-secondary-subtle text-secondary">
                    – 0%
                  </span>
                </ng-container>
              </ng-template>
            </td>
          </tr>

          <!-- Duplications -->
          <tr *ngIf="showDuplications">
            <td class="fw-semibold ps-3">
              <i class="bi bi-files text-info me-2"></i>
              Duplications
            </td>
            <td *ngFor="let scan of selectedScans" class="text-center">
              <span class="badge bg-info-subtle text-info px-3 py-2">
                {{ scan.metrics?.duplicatedLinesDensity ?? 0 }}%
              </span>
            </td>
            <td class="text-center pe-3">
              <ng-container *ngIf="diffMetric('duplicatedLinesDensity') as diff; else showZeroDuplications">
                <span
                  class="badge px-3 py-2"
                  [ngClass]="{
                    'bg-success-subtle text-success': diff < 0,
                    'bg-danger-subtle text-danger': diff > 0
                  }"
                >
                  {{ diff > 0 ? '▲ +' : '▼ ' }}{{ diff }}%
                </span>
              </ng-container>
              <ng-template #showZeroDuplications>
                <ng-container *ngIf="diffMetric('duplicatedLinesDensity') === 0">
                  <span class="badge px-3 py-2 bg-secondary-subtle text-secondary">
                    – 0%
                  </span>
                </ng-container>
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>

    </div>
    <div class="modal-footer-custom">
      <button class="btn btn-primary btn-sm" (click)="closeCompareModal()">Close</button>
    </div>
  </div>
</div>