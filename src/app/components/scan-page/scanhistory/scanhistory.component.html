<div class="scan-history-container p-4">
  <h2><i class="bi bi-journal-text"></i> Scan History</h2>

  <!-- Filter / Search -->
  <div class="filter-row my-3 d-flex flex-wrap align-items-center gap-3">
    
    <!-- 1. Specific Date -->
    <div class="d-flex align-items-center gap-2">
      <label class="fw-bold">Specific Date:</label>
      <input type="date" [(ngModel)]="searchDate" class="form-control form-control-sm" 
             (ngModelChange)="onSearchDateChange()">
    </div>

    <div class="vr"></div>

    <!-- 2. Date Range -->
    <div class="d-flex align-items-center gap-2">
      <label class="fw-bold">Range:</label>
      <div class="date-wrapper">
        <input type="date" [(ngModel)]="startDate" class="form-control form-control-sm" 
               (ngModelChange)="onStartDateChange()" placeholder="Start Date"/>
      </div>
      <span>-</span>
      <div class="date-wrapper">
        <input type="date" [(ngModel)]="endDate" class="form-control form-control-sm" 
               [min]="minEndDate" placeholder="End Date"/>
      </div>
    </div>

    <div class="vr"></div>

    <!-- 3. Status -->
    <div class="d-flex align-items-center gap-2">
      <label class="fw-bold">Status:</label>
      <select class="form-select form-select-sm" [(ngModel)]="statusFilter" style="width: 120px;">
        <option value="ALL">All</option>
        <option value="SUCCESS">Success</option>
        <option value="FAILED">Failed</option>
      </select>
    </div>

    <!-- Buttons -->
    <button class="btn btn-primary btn-sm ms-auto" (click)="applyFilter()">
      <i class="bi bi-search"></i> Search
    </button>
    
    <button class="btn btn-secondary btn-sm" (click)="resetFilters()">
      <i class="bi bi-eraser"></i> Clear
    </button>
  </div>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle scan-history-table">
      <thead class="table-light">
        <tr>
          <th style="width: 40px;">
            <input type="checkbox" [checked]="allSelected()" (change)="toggleSelectAll($event)" />
          </th>
          <th>Date/Time</th>
          <th>Project</th>
          <!-- <th>Owner Scan</th> -->
          <th>Grade</th>
          <th>Issues</th>
          <!-- <th class="log-col sticky-col">Log</th> -->
          <th class="result-col sticky-col">Result</th>
          <th></th>
        </tr>
      </thead>
  
      <tbody>
        <tr *ngFor="let scan of pagedScans" style="cursor: pointer;" (click)="toggleScanSelection(scan)">
           <td (click)="$event.stopPropagation()">
            <!-- Checkbox needs to stop propagation to prevent double toggle from TR click -->
            <input type="checkbox" [checked]="isSelected(scan)" 
                   (change)="toggleScanSelection(scan, $event)" />
          </td>
  
          <td>
            {{scan.completedAt | date:'dd/MM/yyyy'}} <br /> {{scan.completedAt | date:'HH:mm'}}
          </td>
  
          <td>
            {{scan.project.name}} <br />
            <span [ngClass]="statusClass(scan.status)">
              <i [ngClass]="statusIcon(scan.status)"></i> {{scan.status}}
            </span>
          </td>
   <!-- <td>{{scan.ownerScan}}</td> -->
          <td>{{scan.qualityGate}}</td>
  
          <td>
           <span *ngIf="scan.metrics?.bugs !== undefined"><i class="bi bi-bug"></i> {{scan.metrics?.bugs}}</span>
            <span *ngIf="scan.metrics?.vulnerabilities !== undefined"><i class="bi bi-shield"></i> {{scan.metrics?.vulnerabilities}}</span>
            <span *ngIf="scan.metrics?.codeSmells !== undefined"><i class="bi bi-code"></i> {{scan.metrics?.codeSmells}}</span>
            <span *ngIf="scan.metrics?.coverage !== undefined"><i class="bi bi-bar-chart"></i> {{scan.metrics?.coverage}}</span>
              <span *ngIf="scan.metrics?.duplicatedLinesDensity !== undefined"><i class="bi bi-duplicate"></i> {{scan.metrics?.duplicatedLinesDensity}}</span>
          </td>
  
         <td class="log-col sticky-col" (click)="$event.stopPropagation()">
            <button title="View log" class="btn btn-log btn-sm" (click)="viewLog(scan); $event.stopPropagation()">
              <i class="bi bi-file-text"></i> 
            </button>
          </td>
  
          <td class="result-col sticky-col" (click)="$event.stopPropagation()">
            <button title="View Result Scan" class="btn btn-primary btn-sm" (click)="viewResult(scan); $event.stopPropagation()">
              <i class="bi bi-eye"></i> 
            </button>
          </td>
  
        </tr>
      </tbody>
    </table>
  </div>  
  <div class="pagination">
    <!-- Prev -->
    <button class="page-btn prev" [class.disabled]="currentPage === 1"
            (click)="goPage(currentPage - 1)">
      <i class="bi bi-chevron-left"></i>
    </button>
  
    <!-- Page Label -->
    <span class="page-label">Page {{currentPage}} of {{totalPages}}</span>
  
    <!-- Next -->
    <button class="page-btn next" [class.disabled]="currentPage === totalPages"
            (click)="goPage(currentPage + 1)">
      <i class="bi bi-chevron-right"></i>
    </button>
  </div>
  
  

  <!-- Actions -->
  <div class="actions mt-3 d-flex gap-2 flex-wrap">
    <button class="btn btn-success btn-sm" (click)="exportHistory()">
      <i class="bi bi-download"></i> Export History
    </button>
    <button class="btn btn-info btn-sm" (click)="compareScans()">
      <i class="bi bi-bar-chart"></i> Compare Scans
    </button>
  </div>
</div>

<!-- Compare Modal -->
<div *ngIf="showCompareModal" class="modal-backdrop-custom">
  <div class="modal-content-custom">
    <div class="modal-header-custom">
      <h5>Compare Scans</h5>
      <button class="btn btn-primary btn-sm" (click)="closeCompareModal()">X</button>
    </div>
    <div class="modal-body-custom">
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Metric</th>
            <th *ngFor="let scan of selectedScans">{{scan.project?.name}} ({{scan.startedAt | date:'yyyy-MM-dd'}})</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Grade</td>
            <td *ngFor="let scan of selectedScans">{{scan.qualityGate}} </td>
          </tr>
          <tr>
            <td>Bugs</td>
            <td *ngFor="let scan of selectedScans">{{ scan.metrics?.bugs ?? 0 }}</td>
          </tr>
           <tr>
            <td>Code Smells</td>
            <td *ngFor="let scan of selectedScans">{{ scan.metrics?.codeSmells ?? 0 }}</td>
          </tr>

          <tr>
            <td>Coverage (%)</td>
            <td *ngFor="let scan of selectedScans">{{ scan.metrics?.coverage ?? 0 }}</td>
          </tr>

          <tr>
            <td>Duplications</td>
            <td *ngFor="let scan of selectedScans">{{ scan.metrics?.duplicatedLinesDensity ?? 0 }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="modal-footer-custom">
      <button class="btn btn-primary btn-sm" (click)="closeCompareModal()">Close</button>
    </div>
  </div>

</div>
