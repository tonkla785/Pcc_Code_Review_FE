<div class="container my-4">
    <div class="d-flex align-items-center mb-3">
        <button class="back-btn me-2" (click)="goBack()">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h3 class="text-primary mb-0">
            <i class="bi bi-graph-up"></i> Technical Debt Analysis
        </h3>
      </div>
  
    <!-- Summary -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="p-3 border rounded bg-light">
          <strong>Total Debt:</strong> {{ totalDays }} days {{ totalHours }} hours {{ totalMinutes }} minutes
        </div>
      </div>
      <div class="col-md-6">
        <div class="p-3 border rounded bg-light">
          <strong>Estimated Cost:</strong> {{ totalCosts() | currency:'THB ':'symbol':'1.0-0' }}
        </div>
      </div>
    </div>
  
    <!-- Project Distribution -->
    <div class="card mb-4">
      <div class="card-header">
        <i class="bi bi-diagram-3"></i> Debt Distribution by Project
      </div>
      <div class="card-body">
        <div *ngFor="let p of ScanHistoy;" class="mb-3">
          <div class="d-flex justify-content-between">
            <span>{{ p.project.name }}</span>
            <span>{{ (p.metrics?.technicalDebtMinutes || 0) | debtTime }} - {{ formatTHB(p.metrics?.debtRatio || 0) }}</span>
          </div>
          <div class="card p-3 mb-3 shadow-sm">
            <h6 class="card-title mb-2">{{ p.project.name }}</h6>
            
            <div class="progress mb-2" style="height: 10px; background-color: #e9ecef;">
              <div class="progress-bar" role="progressbar"
                [style.width.%]="((p.metrics?.technicalDebtMinutes || 0) / (totalDebtMinutes || 1)) * 100"
                [style.background-color]="toTechDebtDays(p.metrics?.technicalDebtMinutes || 0) <= 7 ? '#28a745' : 
                                           toTechDebtDays(p.metrics?.technicalDebtMinutes || 0) <= 14 ? '#ffc107' : 
                                           toTechDebtDays(p.metrics?.technicalDebtMinutes || 0) <= 21 ? '#fd7e14' : '#dc3545'">
              </div>
            </div>
            
            <small class="text-muted mt-1">{{ (p.metrics?.technicalDebtMinutes || 0) | debtTime }} / {{ totalDebtMinutes | debtTime }} ({{ ((p.metrics?.technicalDebtMinutes || 0) / (totalDebtMinutes || 1)) | percent:'1.0-1' }})</small>
          </div>
          
        </div>
      </div>
    </div>
  
    <div class="row">
        <!-- Categories -->
        <div class="col-md-4">
          <div class="card mb-4">
            <div class="card-header">
              <i class="bi bi-tags"></i> Debt by Category
            </div>
            <div class="card-body">
              <ul class="list-group">
                <li *ngFor="let c of categories; trackBy: trackByName"
                    class="list-group-item d-flex justify-content-between align-items-center">
                  <span><i [ngClass]="c.icon"></i> {{ c.name }}</span>
                  <span>{{ c.percent }}%</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      
        <!-- Debt Trend -->
        <div class="col-md-8">
          <div class="card p-3 shadow-sm mb-4">
            <div class="card-header">
              <i class="bi bi-graph-up"></i> Debt Trend (Monthly)
            </div>
            <div class="card-body">
              <apx-chart
                [series]="debtSeries"
                [chart]="debtChartOptions.chart!"
                [xaxis]="debtChartOptions.xaxis!"
                [stroke]="debtChartOptions.stroke!"
                [yaxis]="debtChartOptions.yaxis!"
                [dataLabels]="debtChartOptions.dataLabels!"
                [tooltip]="debtChartOptions.tooltip!"
                [title]="debtChartOptions.title!"
                [colors]="debtChartOptions.colors!">
              </apx-chart>
            </div>
          </div>
        </div>
      </div>
      
      
  
  
    <!-- Top Debt Items -->
    <div class="card mb-4">
      <div class="card-header">
        <i class="bi bi-exclamation-triangle"></i> Top Debt Project
      </div>
      <div class="card-body table-responsive">
        <table class="table table-bordered table-striped">
          <thead class="table-light">
            <tr>
              <th class="py-3 px-4 text-left font-semibold">Priority</th>
              <th class="py-3 px-4 text-left font-semibold">Project</th>
              <th class="py-3 px-4 text-left font-semibold">Time</th>
              <th class="py-3 px-4 text-right font-semibold">Cost (THB)</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let i of topDebtItems; trackBy: trackByItem">
              <td>
                <span class="badge"
                      [ngClass]="{
                        'bg-danger': i.priority === 'High',
                        'bg-warning text-dark': i.priority === 'Med',
                        'bg-success': i.priority === 'Low'
                      }">
                  {{ i.priority }}
                </span>
              </td>
              <td>{{ i.item }}</td>
              <td>{{ i.time | debtTime }}</td> 
              <td>{{ formatTHB(i.cost) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  
    <!-- Actions -->
    <div class="d-flex justify-content-center gap-2">
      <button class="btn btn-primary" (click)="generateDebtReport()">
        <i class="bi bi-file-earmark-text"></i> Generate Debt Report
      </button>
      <button class="btn btn-outline-success" (click)="exportToExcel()">
        <i class="bi bi-file-earmark-excel"></i> Export to Excel
      </button>
      <!-- <button class="btn btn-warning" (click)="openModal()">
        <i class="bi bi-list-check"></i> Generate Action Plan
      </button> -->
    </div>
  </div>

 <!-- Modal -->
<div class="custom-modal-backdrop" *ngIf="isModalOpen">
  <div class="custom-modal">
    <div class="modal-header">
      <h5 class="modal-title">Action Plan (Draft)</h5>
      <button type="button" class="btn-close" (click)="closeModal()"></button>
    </div>

    <div class="modal-body">
      <pre>{{ actionPlanText }}</pre>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeModal()">Close</button>
      <button type="button" class="btn btn-success">Save Plan</button>
    </div>
  </div>
</div>
  