<div class="page-container fade-in">
  <!-- Header Section -->
  <header class="page-header">
    <div class="header-content">
      <button class="back-link" routerLink="/repositories" title="Back to Repositories">
        <i class="bi bi-arrow-left"></i>
      </button>

      <div class="project-info">
        <div class="project-icon" [ngClass]="repo?.projectTypeLabel === 'ANGULAR' ? 'icon-angular' : 'icon-spring'">
          <i class="bi" [ngClass]="repo?.projectTypeLabel === 'ANGULAR' ? 'bi-filetype-ts' : 'bi-filetype-java'"></i>
        </div>
        <div class="project-details">
          <h1 class="project-name">
            {{ repo?.name }}
            <span class="type-badge"
              [ngClass]="repo?.projectTypeLabel === 'ANGULAR' ? 'badge-angular' : 'badge-spring'">
              {{ repo?.projectTypeLabel }}
            </span>
          </h1>
          <a [href]="repo?.repositoryUrl" target="_blank" class="repo-url">
            <i class="bi bi-link-45deg"></i> {{ repo?.repositoryUrl }}
          </a>
        </div>
      </div>
    </div>

    <div class="header-actions">
      <div class="status-indicator" [ngClass]="getStatusClass(repo?.status)">
        <span class="status-dot"></span>
        {{ repo?.status }}
      </div>
      <button class="btn-settings" (click)="editRepo(repo!)">
        <i class="bi bi-gear-fill"></i> Settings
      </button>
    </div>
  </header>

  <!-- Key Metrics Grid -->
  <section class="metrics-grid">
    <!-- Quality Gate -->
    <div class="metric-card quality-gate">
      <div class="metric-header">
        <div class="icon-box"><i class="bi bi-shield-check"></i></div>
        <span class="metric-label">Quality Gate</span>
      </div>
      <div class="metric-value">
        <span class="gate-badge" [ngClass]="getQualityGateClass(repo?.qualityGate || '')">
          {{ repo?.qualityGate || 'N/A' }}
        </span>
      </div>
    </div>

    <!-- Bugs -->
    <div class="metric-card">
      <div class="metric-header">
        <div class="icon-box bug-icon"><i class="bi bi-bug-fill"></i></div>
        <span class="metric-label">Bugs</span>
      </div>
      <div class="metric-value">
        {{ repo?.metrics?.bugs || 0 }}
      </div>
    </div>

    <!-- Vulnerabilities -->
    <div class="metric-card">
      <div class="metric-header">
        <div class="icon-box vuln-icon"><i class="bi bi-shield-exclamation"></i></div>
        <span class="metric-label">Vulnerabilities</span>
      </div>
      <div class="metric-value">
        {{ repo?.metrics?.vulnerabilities || 0 }}
      </div>
    </div>

    <!-- Coverage -->
    <div class="metric-card">
      <div class="metric-header">
        <div class="icon-box coverage-icon"><i class="bi bi-graph-up"></i></div>
        <span class="metric-label">Coverage</span>
      </div>
      <div class="metric-value">
        {{ repo?.metrics?.coverage || 0 }}%
      </div>
      <div class="progress-mini">
        <div class="progress-bar-fill" [style.width.%]="repo?.metrics?.coverage || 0"></div>
      </div>
    </div>
  </section>

  <!-- Main Content Tabs -->
  <section class="content-section">
    <div class="tabs-header">
      <button class="tab-item" [class.active]="activeTab==='overview'" (click)="switchTab('overview')">
        <i class="bi bi-grid-1x2"></i> Overview
      </button>
      <button class="tab-item" [class.active]="activeTab==='bugs'" (click)="switchTab('bugs')">
        <i class="bi bi-bug"></i> Issues
        <span class="count-badge" *ngIf="issues.length > 0">{{ issues.length }}</span>
      </button>
      <button class="tab-item" [class.active]="activeTab==='history'" (click)="switchTab('history')">
        <i class="bi bi-clock-history"></i> History
      </button>
    </div>

    <div class="tab-content">
      <!-- Overview Tab -->
      <div *ngIf="activeTab==='overview'" class="fade-in-up">
        <div class="overview-panel">

          <div *ngIf="repo?.status === 'Scanning'" class="scanning-alert">
            <div class="alert-content">
              <i class="bi bi-arrow-repeat spin"></i>
              <span>Analysis in progress...</span>
            </div>
            <div class="scan-progress-bar">
              <div class="bar-fill" [style.width.%]="repo?.scanningProgress || 0"></div>
            </div>
            <span class="progress-text">{{ repo?.scanningProgress || 0 }}%</span>
          </div>

          <div class="details-list">
            <div class="detail-item">
              <span class="label">Last Analysis</span>
              <span class="value">
                <i class="bi bi-calendar3"></i>
                {{ repo?.lastScan ? (repo?.lastScan | date:'medium') : 'No scan history' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="label">Sonar Project Key</span>
              <span class="value code-style">{{ repo?.sonarProjectKey || '-' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Cost / Day</span>
              <span class="value">{{ repo?.costPerDay | number:'1.0-2' }} à¸¿</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Issues Tab -->
      <div *ngIf="activeTab==='bugs'" class="fade-in-up">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Message</th>
                <th>Severity</th>
                <th>Status</th>
                <th>Assignee</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let issue of paginatedIssues">
                <td>
                  <span class="type-pill" [class.pill-bug]="issue.type === 'Bug'"
                    [class.pill-vuln]="issue.type === 'Vulnerability'">
                    {{ issue.type }}
                  </span>
                </td>
                <td class="msg-col" [title]="issue.message">{{ issue.message }}</td>
                <td>
                  <span class="severity-tag" [ngClass]="'sev-' + (issue.severity | lowercase)">
                    {{ issue.severity }}
                  </span>
                </td>
                <td><span class="status-text">{{ formatStatus(issue.status) }}</span></td>
                <td>
                  <div class="user-cell">
                    <div class="user-avatar">{{ (issue.assignedTo?.username || '?').charAt(0) }}</div>
                    <span>{{ issue.assignedTo?.username || 'Unassigned' }}</span>
                  </div>
                </td>
              </tr>
              <tr *ngIf="issues.length === 0">
                <td colspan="5" class="empty-row">
                  <i class="bi bi-check2-circle"></i> No issues found
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls" *ngIf="issues.length > pageSize">
          <button class="btn btn-sm btn-outline-secondary" (click)="prevPage()" [disabled]="currentPage === 1">
            <i class="bi bi-chevron-left"></i> Previous
          </button>
          <span class="page-info">
            Page {{ currentPage }} of {{ totalPages }}
          </span>
          <button class="btn btn-sm btn-outline-secondary" (click)="nextPage()" [disabled]="currentPage === totalPages">
            Next <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>

      <!-- History Tab -->
      <div *ngIf="activeTab==='history'" class="fade-in-up">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Status</th>
                <th>Metrics (Bugs / Vulns / Cov)</th>
                <th>Quality Gate</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let scan of scans">
                <td class="date-col">
                  {{ scan.completedAt | date:'medium' }}
                </td>
                <td>
                  <span class="status-pill-sm" [ngClass]="getStatusClass(scan.status)">
                    {{ scan.status }}
                  </span>
                </td>
                <td>
                  <div class="mini-stats">
                    <span title="Bugs" class="stat-bug"><i class="bi bi-bug-fill"></i> {{ scan.metrics?.bugs || 0
                      }}</span>
                    <span title="Vulnerabilities" class="stat-vuln"><i class="bi bi-shield-fill-exclamation"></i> {{
                      scan.metrics?.vulnerabilities || 0 }}</span>
                    <span title="Coverage" class="stat-cov"><i class="bi bi-bar-chart-fill"></i> {{
                      scan.metrics?.coverage || 0 }}%</span>
                  </div>
                </td>
                <td>
                  <span *ngIf="scan.qualityGate === 'OK'" class="gate-tag active">Passed</span>
                  <span *ngIf="scan.qualityGate === 'ERROR'" class="gate-tag failed">Failed</span>
                  <span *ngIf="scan.qualityGate !== 'OK' && scan.qualityGate !== 'ERROR'" class="gate-tag"
                    [ngClass]="getQualityGateClass(scan.qualityGate || '')">
                    {{ scan.qualityGate }}
                  </span>
                </td>
              </tr>
              <tr *ngIf="scans.length === 0">
                <td colspan="4" class="empty-row">
                  <i class="bi bi-clock-history"></i> No scan history
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </section>
</div>